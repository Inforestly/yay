local Players = game:GetService('Players')
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp, humanoid

-- Function to get current character and components
local function getChar()
    character = player.Character or player.CharacterAdded:Wait()
    hrp = character:WaitForChild("HumanoidRootPart")
    humanoid = character:WaitForChild("Humanoid")
    return character, hrp, humanoid
end

getChar()

-- Automatically update references on respawn
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    hrp = newChar:WaitForChild("HumanoidRootPart")
    humanoid = newChar:WaitForChild("Humanoid")
end)

-- Config
local DELAY_BETWEEN = 3
local WALK_SPEED = 35
local DEFAULT_KEY = Enum.KeyCode.RightShift
local currentKeybind = DEFAULT_KEY

-- GUI Setup
local screenGui = Instance.new('ScreenGui')
screenGui.Name = 'TeleportGUI'
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild('PlayerGui')

local frame = Instance.new('Frame')
frame.Size = UDim2.new(0, 250, 0, 180)
frame.Position = UDim2.new(0.5, -125, 0.4, -90)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui
Instance.new('UICorner', frame).CornerRadius = UDim.new(0, 14)

local toggleBtn = Instance.new('TextButton')
toggleBtn.Size = UDim2.new(0.8, 0, 0, 50)
toggleBtn.Position = UDim2.new(0.1, 0, 0.15, 0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 22
toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.Text = "Start"
toggleBtn.TextScaled = true
toggleBtn.Parent = frame
Instance.new('UICorner', toggleBtn).CornerRadius = UDim.new(0, 14)

local keybindBtn = Instance.new('TextButton')
keybindBtn.Size = UDim2.new(0.8, 0, 0, 35)
keybindBtn.Position = UDim2.new(0.1, 0, 0.50, 0)
keybindBtn.BackgroundTransparency = 1
keybindBtn.Font = Enum.Font.GothamBold
keybindBtn.TextSize = 18
keybindBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
keybindBtn.Text = "Change Keybind ("..currentKeybind.Name..")"
keybindBtn.TextScaled = true
keybindBtn.Parent = frame

local status = Instance.new('TextLabel')
status.Size = UDim2.new(0.8, 0, 0, 30)
status.Position = UDim2.new(0.1, 0, 0.70, 0)
status.BackgroundTransparency = 1
status.Font = Enum.Font.GothamBold
status.TextSize = 18
status.TextColor3 = Color3.fromRGB(255, 255, 255)
status.Text = "Status: ðŸŸ  Idle"
status.TextScaled = true
status.TextWrapped = true
status.Parent = frame

-- Teleport targets
local housesFolder = workspace:WaitForChild("Worlds"):WaitForChild("Christmas World"):WaitForChild("GiveGifts")
local activations = {}

local function refreshActivations()
    activations = {}
    for _, obj in ipairs(housesFolder:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Name == "Root" and obj.Parent and obj.Parent.Name == "Activation" then
            table.insert(activations, obj)
        end
    end
end

-- Loop logic
local running = false
local waitingForKey = false

local function startLoop()
    running = true
    status.Text = "Status: ðŸŸ¢ Running"
    toggleBtn.Text = "Stop"
    toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)

    task.spawn(function()
        while running do
            local ok, err = pcall(function()
                getChar()
                humanoid.WalkSpeed = WALK_SPEED
                refreshActivations()

                for _, rootPart in ipairs(activations) do
                    if not running then break end
                    if rootPart and rootPart.Parent then
                        character:PivotTo(CFrame.new(rootPart.Position))

                        local timer = 0
                        while running and timer < DELAY_BETWEEN do
                            humanoid.WalkSpeed = WALK_SPEED
                            timer += RunService.Heartbeat:Wait()
                        end
                    end
                end
            end)

            if not ok then
                warn("Loop error:", err)
            end

            RunService.Heartbeat:Wait()
        end
    end)
end

local function stopLoop()
    running = false
    status.Text = "Status: ðŸŸ  Idle"
    toggleBtn.Text = "Start"
    toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
end

local function toggleLoop()
    if running then stopLoop() else startLoop() end
end

toggleBtn.MouseButton1Click:Connect(toggleLoop)

-- Unified input handler
UIS.InputBegan:Connect(function(input, gp)
    if not gp then
        -- Toggle GUI visibility
        if input.KeyCode == currentKeybind then
            frame.Visible = not frame.Visible
        end

        -- Change keybind
        if waitingForKey and input.KeyCode ~= Enum.KeyCode.Unknown then
            waitingForKey = false
            currentKeybind = input.KeyCode
            keybindBtn.Text = "Change Keybind ("..currentKeybind.Name..")"
        end
    end
end)

keybindBtn.MouseButton1Click:Connect(function()
    waitingForKey = true
    keybindBtn.Text = "Press any key..."
end)
